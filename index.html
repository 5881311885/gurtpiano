<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gurt Piano — Falling Keys</title>
<style>
  :root{
    --bg: #0b0710;
    --panel: linear-gradient(180deg,#0f0620,#0b0520);
    --pink: #ff6fbf;
    --blue: #5fb3ff;
    --key-gap: 6px;
    --key-height: 120px;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  .wrap{display:flex;flex-direction:column;min-height:100vh}
  header{padding:14px 18px; display:flex; align-items:center; gap:12px}
  h1{margin:0;font-size:18px; letter-spacing:0.6px}
  p.lead{margin:0;color:rgba(255,255,255,0.75);font-size:13px}
  .stage{flex:1; position:relative; overflow:hidden; background:radial-gradient(1200px 600px at 10% 10%, rgba(95,179,255,0.06), transparent 8%), radial-gradient(900px 400px at 90% 90%, rgba(255,111,191,0.04), transparent 6%); }
  /* falling notes container */
  .notes{position:absolute; inset:0; pointer-events:none; overflow:hidden}
  .note{
    position:absolute; left:0; width:var(--key-w,64px); height:var(--note-h,64px); transform:translateY(-140%);
    will-change:transform,opacity;
    display:flex; align-items:center; justify-content:center; overflow:visible;
    opacity:0.98;
    filter: drop-shadow(0 12px 30px rgba(0,0,0,0.7));
  }
  .note img{ width:100%; height:100%; object-fit:cover; display:block; pointer-events:none; user-select:none; }
  /* keybed at bottom */
  .keyboard{
    position:relative; display:flex; gap:var(--key-gap); padding:12px; align-items:flex-end;
    box-sizing:border-box; background:var(--panel); border-top:1px solid rgba(255,255,255,0.03);
    min-height:var(--key-height);
  }
  .key{
    flex:1 1 auto; min-width:36px; height:calc(var(--key-height) - 24px);
    border-radius:8px; overflow:hidden; position:relative; cursor:pointer;
    display:flex; align-items:center; justify-content:center; user-select:none;
    transition:transform .12s ease, box-shadow .12s ease;
    border: 1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  }
  .key img{ width:100%; height:100%; object-fit:cover; display:block; pointer-events:none; }
  .key .label{
    position:absolute; bottom:6px; left:6px; right:6px; text-align:center; font-size:13px; color:rgba(255,255,255,0.9);
    text-shadow: 0 2px 8px rgba(0,0,0,0.6); font-weight:600;
  }
  .key:active, .key.active{
    transform: translateY(6px) scale(0.99);
    box-shadow: 0 6px 22px rgba(0,0,0,0.6);
  }
  /* highlight overlay */
  .key::after{
    content:""; position:absolute; inset:0; background:linear-gradient(90deg, rgba(255,111,191,0.06), rgba(95,179,255,0.04)); opacity:0; transition:opacity .12s;
    pointer-events:none;
  }
  .key.active::after{ opacity:1; }
  /* falling animation (we'll vary duration inline) */
  @keyframes fall {
    0%{ transform: translateY(-140%) scale(0.92); opacity:0 }
    8%{ opacity:1 }
    85%{ transform: translateY(110vh) scale(1.02); opacity:1 }
    100%{ transform: translateY(120vh) scale(1.06); opacity:0 }
  }
  /* small UI footer */
  .footerUI{position:absolute; left:14px; top:14px; z-index:40; background:rgba(0,0,0,0.32); padding:8px 10px; border-radius:8px; font-family:monospace; font-size:13px}
  .legend{position:absolute; right:14px; top:14px; background:rgba(0,0,0,0.22); padding:8px 10px; border-radius:8px; font-size:13px}
  /* responsive tweaks */
  @media (max-width:720px){ :root{ --key-height:96px } .key .label{font-size:12px} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Gurt Piano</h1>
      <p class="lead">Press any letter key (A–Z) or click a key. Notes fall from above when played. Place <code>gurtt.png</code> and <code>gurt.mp3</code> alongside this file.</p>
    </header>

    <div class="stage" id="stage">
      <div class="notes" id="notes"></div>

      <div class="footerUI" id="status">Theme: pink ↔ blue • Falling notes on press</div>
      <div class="legend">Click / Type • 26 keys</div>

      <!-- keyboard UI -->
      <div class="keyboard" id="keyboard"></div>
    </div>
  </div>

<script>
/*
  Gurt Piano
  - Requires files in same folder:
      gurtt.png    (image used for each key & falling note)
      gurt.mp3     (single audio file; we'll change playbackRate for pitch)
  - Keys A..Z mapped across semitones. Pressing plays gurt.mp3 at different pitches.
  - Falling note element is created only when a key is pressed.
*/

// CONFIG
const IMAGE_SRC = 'gurtt.png';
const AUDIO_SRC = 'gurt.mp3';
const KEYLETTERS = Array.from('ABCDEFGHIJKLMNOPQRSTUVWXYZ'); // 26 keys
// choose a base note index (C4-ish) and map keys across 2+ octaves:
const BASE_SEMITONE = -9; // relative shift to center pitch (adjust to taste)
// mapping semitone offsets for each key: linear across the letters
const SEMITONE_SPAN = 24; // spread across 24 semitones (~2 octaves)

// helper: semitone -> playbackRate
function semitoneToPlaybackRate(semitones) {
  return Math.pow(2, semitones / 12);
}

// DOM refs
const keyboard = document.getElementById('keyboard');
const notesLayer = document.getElementById('notes');
const stage = document.getElementById('stage');
const status = document.getElementById('status');

// create audio template (we'll clone elements for polyphony)
const audioTemplate = new Audio(AUDIO_SRC);
audioTemplate.preload = 'auto';

// build key elements
let keyElements = {};
function buildKeys(){
  keyboard.innerHTML = '';
  KEYLETTERS.forEach((letter, i) => {
    const key = document.createElement('button');
    key.className = 'key';
    key.dataset.letter = letter;
    // label and image
    const img = document.createElement('img');
    img.src = IMAGE_SRC;
    img.alt = letter;
    key.appendChild(img);
    const label = document.createElement('div');
    label.className = 'label';
    label.textContent = letter;
    key.appendChild(label);

    // click handler
    key.addEventListener('pointerdown', (ev) => {
      ev.preventDefault();
      playKey(letter);
      flashKey(letter);
    });

    keyboard.appendChild(key);
    keyElements[letter] = key;
  });
}
buildKeys();

// compute semitone per key (spread evenly)
function semitoneForIndex(i){
  const halfSpan = SEMITONE_SPAN / 2;
  // map i in [0..25] to [-halfSpan .. +halfSpan]
  const ratio = (i / (KEYLETTERS.length - 1)); // 0..1
  return Math.round((ratio * SEMITONE_SPAN) - halfSpan) + BASE_SEMITONE;
}

// play function (create a new audio element to allow overlaps)
function playKey(letter){
  const idx = KEYLETTERS.indexOf(letter.toUpperCase());
  if (idx === -1) return;
  const semitone = semitoneForIndex(idx);
  const rate = semitoneToPlaybackRate(semitone);

  // clone audio element so multiple can play
  try {
    const audio = audioTemplate.cloneNode(true);
    audio.preload = 'auto';
    audio.playbackRate = rate;
    audio.currentTime = 0;
    // small volume envelope for nicer sound (if browser supports)
    audio.volume = 0.95;
    // attempt to play (returns promise)
    const p = audio.play();
    if (p && p.catch) p.catch(()=>{/* ignore autoplay restrictions until user interacts */});
    // cleanup after finished
    audio.addEventListener('ended', ()=>{ audio.remove(); });
    // create falling note visually
    spawnFallingNoteForIndex(idx);
  } catch (err){
    console.error('Audio play error', err);
  }
}

// visual: spawn falling note above corresponding key index
function spawnFallingNoteForIndex(idx){
  const keyEl = keyElements[ KEYLETTERS[idx] ];
  if (!keyEl) return;
  const rect = keyEl.getBoundingClientRect();
  const stageRect = stage.getBoundingClientRect();
  // compute horizontal center relative to notes layer
  const left = rect.left - stageRect.left + (rect.width - rect.width*0.9)/2;
  const width = Math.max(36, rect.width * 0.9);
  const height = Math.max(32, rect.height * 0.9);

  const note = document.createElement('div');
  note.className = 'note';
  note.style.left = `${left}px`;
  note.style.width = `${width}px`;
  note.style.height = `${height}px`;

  // randomize slight horizontal jitter & rotation
  const jitter = (Math.random() - 0.5) * Math.min(20, width * 0.25);
  note.style.transform = `translateY(-140%) translateX(${jitter}px) scale(0.98)`;
  note.style.opacity = '0.98';

  // append image
  const img = document.createElement('img');
  img.src = IMAGE_SRC;
  note.appendChild(img);

  // set animation duration based on key pitch (higher pitches fall a bit faster)
  const idxRatio = idx / (KEYLETTERS.length - 1);
  const baseDur = 1800; // ms
  const duration = baseDur - Math.round(idxRatio * 700) + Math.round(Math.random() * 400);
  note.style.animation = `fall ${duration}ms cubic-bezier(.12,.9,.28,1) forwards`;

  // small rotation based on key index
  const rot = (idx - KEYLETTERS.length/2) * 0.8;
  note.style.transition = 'transform linear';
  note.style.willChange = 'transform,opacity';

  notesLayer.appendChild(note);

  // remove when animation ends
  note.addEventListener('animationend', () => {
    note.remove();
  });

  // optional: make it slightly scale/pop when created
  requestAnimationFrame(()=> {
    note.style.transform = `translateY(-140%) translateX(${jitter}px) scale(1) rotate(${rot}deg)`;
  });
}

// key highlight (visual)
function flashKey(letter){
  const key = keyElements[letter.toUpperCase()];
  if (!key) return;
  key.classList.add('active');
  setTimeout(()=> key.classList.remove('active'), 180);
}

// keyboard handler
window.addEventListener('keydown', (e) => {
  // ignore modifier-only
  if (e.metaKey || e.altKey || e.ctrlKey) return;
  const key = (e.key || '').toUpperCase();
  if (KEYLETTERS.includes(key)){
    e.preventDefault();
    playKey(key);
    flashKey(key);
  }
});

// touch-friendly: allow pointerdown on keys (already set), also handle pointerup/out
// add keyboard layout recalculation on resize to set CSS variable (--key-w)
function recalcKeyWidth(){
  const firstKey = keyboard.querySelector('.key');
  if (!firstKey) return;
  const rect = firstKey.getBoundingClientRect();
  document.documentElement.style.setProperty('--key-w', `${rect.width}px`);
  // also set note image height variable
  document.documentElement.style.setProperty('--note-h', `${rect.height}px`);
}
window.addEventListener('resize', recalcKeyWidth);
setTimeout(recalcKeyWidth, 200);

// small hint on first user interaction (unlock audio on some browsers)
function ensureAudioUnlocked() {
  try {
    const a = new Audio();
    a.src = AUDIO_SRC;
    a.play().then(()=> a.pause()).catch(()=>{/*ignore*/});
  } catch(e){}
}
['pointerdown','keydown','touchstart'].forEach(ev => {
  window.addEventListener(ev, ensureAudioUnlocked, { once:true, passive:true });
});

// friendly fallback if assets are missing
audioTemplate.addEventListener('error', ()=> {
  status.textContent = 'Missing audio file: gurt.mp3 (place it next to this HTML).';
});
const testImg = new Image();
testImg.src = IMAGE_SRC;
testImg.onload = ()=>{/* ok */};
testImg.onerror = ()=>{ status.textContent = 'Missing image: gurtt.png (place it next to this HTML).'; };

// small accessibility: focus ring for keyboard nav
Object.values(keyElements).forEach(k => k.addEventListener('focus', ()=> k.classList.add('active')));
Object.values(keyElements).forEach(k => k.addEventListener('blur', ()=> k.classList.remove('active')));

// done
status.textContent = 'Ready — press any letter (A–Z) or click a key to play.';
</script>
</body>
</html>
